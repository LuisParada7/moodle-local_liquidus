{"version":3,"file":"google-lazy.min.js","sources":["../src/google-lazy.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Loads Segment tracker.\n *\n * @copyright Copyright (c) 2020 Open LMS\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery','core/log', 'core/templates'],\n    function($, Log, Templates) {\n\n        var self = this;\n\n        var tracker = {};\n\n        self.addAnalyticsJS = function() {\n            var dfd = $.Deferred();\n            var siteid = tracker.trackerInfo.siteid;\n            var lengthgid = siteid.length;\n            var courseId = tracker.trackerInfo.staticShares.courseId;\n            if (typeof courseId === 'undefined') {\n                courseId = siteid[0];\n            }\n            if (!siteid) {\n                Log.debug('Liquidus is misconfigured for Google, Site ID is missing.');\n                return;\n            }\n            var context = [];\n            context['siteid'] = siteid[0];\n            context['courseId'] = courseId;\n            context['gacodes'] = [];\n            context['uacodes'] = [];\n            var startWith = '';\n            for (var count = 0; count < lengthgid; count++) {\n                startWith = siteid[count].substring(0, 2);\n                if (startWith === 'G-') {\n                    context['gacodes'].push(siteid[count]);\n                } else {\n                    context['uacodes'].push(siteid[count]);\n                }\n            }\n\n            Templates.render('local_liquidus/gtag', context).then(function (html) {\n                $('body').append(html);\n                if (typeof gtag === 'undefined') {\n                    dfd.fail();\n                    return;\n                }\n                /* global gtag */\n                self.gtag = gtag;\n                dfd.resolve();\n            });\n            return dfd;\n        };\n\n        tracker.loadTracker = function(trackerInfo) {\n            tracker.trackerInfo = trackerInfo;\n            return self.addAnalyticsJS();\n        };\n\n        tracker.identify = function() {}; // User hash is already sent in trackPage.\n\n        tracker.trackPage = function() {\n            if (tracker.trackerInfo.staticShares.plugins) {\n                const plugins = tracker.trackerInfo.staticShares.plugins;\n                Object.entries(plugins).forEach(\n                    ([type, value]) => {\n                        value.forEach(pluginId => {\n                            const eventId = type + '_' + pluginId;\n                            const eventCategory = 'pluginUsed';\n                            self.gtag('event', eventId, {\n                                event_category: eventCategory\n                            });\n                        });\n                    });\n                delete tracker.trackerInfo.staticShares.plugins;\n            }\n\n            if (tracker.trackerInfo.staticShares.userRole) {\n                const userRole = tracker.trackerInfo.staticShares.userRole;\n                self.gtag('event', userRole.join(','), {\n                    event_category: 'userRole'\n                });\n                delete tracker.trackerInfo.staticShares.userRole;\n            }\n\n            Object.entries(tracker.trackerInfo.staticShares).forEach(\n                ([eventCategory, eventId]) => {\n                    self.gtag('event', eventId, {\n                        event_category: eventCategory\n                    });\n                }\n            );\n        };\n\n        tracker.processEvent = function(dfd, metricName, data) {\n            self.gtag('event', metricName, {\n                'userHash': tracker.trackerInfo.staticShares.userHash,\n                'eventData': data,\n                'event_callback': function() {\n                    dfd.resolve();\n                }\n            });\n        };\n\n        return tracker;\n    });\n"],"names":["define","$","Log","Templates","self","this","tracker","addAnalyticsJS","dfd","Deferred","siteid","trackerInfo","lengthgid","length","courseId","staticShares","context","count","substring","push","render","then","html","append","gtag","resolve","fail","debug","loadTracker","identify","trackPage","plugins","Object","entries","forEach","_ref","type","value","pluginId","eventId","event_category","userRole","join","_ref2","eventCategory","processEvent","metricName","data","userHash"],"mappings":";;;;;;AAqBAA,oCAAO,CAAC,SAAS,WAAY,mBACzB,SAASC,EAAGC,IAAKC,eAETC,KAAOC,KAEPC,QAAU,UAEdF,KAAKG,eAAiB,eACdC,IAAMP,EAAEQ,WACRC,OAASJ,QAAQK,YAAYD,OAC7BE,UAAYF,OAAOG,OACnBC,SAAWR,QAAQK,YAAYI,aAAaD,iBACxB,IAAbA,WACPA,SAAWJ,OAAO,IAEjBA,YAIDM,QAAU,GACdA,QAAO,OAAaN,OAAO,GAC3BM,QAAO,SAAeF,SACtBE,QAAO,QAAc,GACrBA,QAAO,QAAc,WAEZC,MAAQ,EAAGA,MAAQL,UAAWK,QAEjB,OADNP,OAAOO,OAAOC,UAAU,EAAG,GAEnCF,QAAO,QAAYG,KAAKT,OAAOO,QAE/BD,QAAO,QAAYG,KAAKT,OAAOO,eAIvCd,UAAUiB,OAAO,sBAAuBJ,SAASK,MAAK,SAAUC,MAC5DrB,EAAE,QAAQsB,OAAOD,MACG,oBAATE,MAKXpB,KAAKoB,KAAOA,KACZhB,IAAIiB,WALAjB,IAAIkB,UAOLlB,IA5BHN,IAAIyB,MAAM,8DA+BlBrB,QAAQsB,YAAc,SAASjB,oBAC3BL,QAAQK,YAAcA,YACfP,KAAKG,kBAGhBD,QAAQuB,SAAW,aAEnBvB,QAAQwB,UAAY,cACZxB,QAAQK,YAAYI,aAAagB,QAAS,OACpCA,QAAUzB,QAAQK,YAAYI,aAAagB,QACjDC,OAAOC,QAAQF,SAASG,SACpBC,WAAEC,KAAMC,YACJA,MAAMH,SAAQI,iBACJC,QAAUH,KAAO,IAAME,SAE7BlC,KAAKoB,KAAK,QAASe,QAAS,CACxBC,eAFkB,4BAM3BlC,QAAQK,YAAYI,aAAagB,WAGxCzB,QAAQK,YAAYI,aAAa0B,SAAU,OACrCA,SAAWnC,QAAQK,YAAYI,aAAa0B,SAClDrC,KAAKoB,KAAK,QAASiB,SAASC,KAAK,KAAM,CACnCF,eAAgB,oBAEblC,QAAQK,YAAYI,aAAa0B,SAG5CT,OAAOC,QAAQ3B,QAAQK,YAAYI,cAAcmB,SAC7CS,YAAEC,cAAeL,eACbnC,KAAKoB,KAAK,QAASe,QAAS,CACxBC,eAAgBI,oBAMhCtC,QAAQuC,aAAe,SAASrC,IAAKsC,WAAYC,MAC7C3C,KAAKoB,KAAK,QAASsB,WAAY,UACfxC,QAAQK,YAAYI,aAAaiC,mBAChCD,oBACK,WACdvC,IAAIiB,cAKTnB"}